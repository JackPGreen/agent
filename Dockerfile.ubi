FROM registry.access.redhat.com/ubi9:9.5 AS base-builder

# hadolint ignore=DL3041
RUN dnf update -y && \
    dnf install -y cmake3 diffutils gcc gcc-c++ git m4 make openssl-devel patch systemd-devel tar unzip libyaml-devel cyrus-sasl-devel zlib-devel pcre2-devel && \
    dnf clean all && rm -rf /var/cache/dnf

# Provide the dependencies for record accessor built from source
ARG BISON_VER=3.8.2
ARG BISON_URL=https://www.mirrorservice.org/sites/ftp.gnu.org/gnu/bison/
ARG FLEX_VER=2.6.4
ARG FLEX_URL=https://github.com/westes/flex/releases/download/v${FLEX_VER}
ADD ${BISON_URL}/bison-${BISON_VER}.tar.gz /bison/
ADD ${FLEX_URL}/flex-${FLEX_VER}.tar.gz /flex/
RUN tar -xzvf /bison/bison-${BISON_VER}.tar.gz -C /bison/ && tar -xzvf /flex/flex-${FLEX_VER}.tar.gz -C /flex/

# Flex needs Bison so do first
WORKDIR /bison/bison-${BISON_VER}/
RUN ./configure && make -j "$(getconf _NPROCESSORS_ONLN)" && make install
WORKDIR /flex/flex-${FLEX_VER}/
RUN ./configure && make -j "$(getconf _NPROCESSORS_ONLN)" && make install

# Build libssh2 from source
ARG LIBSSH2_VER=1.11.1
WORKDIR /tmp
RUN curl -LO https://www.libssh2.org/download/libssh2-${LIBSSH2_VER}.tar.gz && \
    tar xf libssh2-${LIBSSH2_VER}.tar.gz
WORKDIR /tmp/libssh2-${LIBSSH2_VER}
RUN ./configure --with-openssl --prefix=/usr/local && \
    make -j "$(getconf _NPROCESSORS_ONLN)" && make install && \
    ldconfig

# Build libgit2 from source
ARG LIBGIT2_VER=1.9.1
WORKDIR /tmp
RUN git clone --branch v${LIBGIT2_VER} --depth 1 https://github.com/libgit2/libgit2.git
WORKDIR /tmp/libgit2
RUN cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON \
          -DUSE_SSH=ON -DBUILD_TESTS=OFF -DBUILD_CLI=OFF && \
    cmake --build build --target install -- -j "$(getconf _NPROCESSORS_ONLN)" && \
    echo "/usr/local/lib64" > /etc/ld.so.conf.d/libgit2.conf && \
    ldconfig

FROM base-builder AS source-builder

# Fluent Bit version
ARG FLUENT_BIT_VERSION
ENV FLUENTBIT_VERSION=$FLUENT_BIT_VERSION
ARG FLB_NIGHTLY_BUILD
ENV FLB_NIGHTLY_BUILD=$FLB_NIGHTLY_BUILD

ARG FLUENTDO_AGENT_VERSION=25.11.1
ENV FLUENTDO_AGENT_VERSION=${FLUENTDO_AGENT_VERSION}

# Build metadata
ARG FLUENTDO_AGENT_DISTRO=ubi/9.5
ENV FLUENTDO_AGENT_DISTRO=$FLUENTDO_AGENT_DISTRO

ARG FLUENTDO_AGENT_PACKAGE_TYPE=CONTAINER
ENV FLUENTDO_AGENT_PACKAGE_TYPE=$FLUENTDO_AGENT_PACKAGE_TYPE

# Copy any local source files as needed
WORKDIR /source/
COPY source/ /source/

# Some components assume a git repository is present, so we create one otherwise it fails
RUN git init -q /source/ && \
    git config user.name "Fluent Do Agent Builder" && \
    git config user.email "info@fluent.do" && \
    git add -A && \
    git commit -q -a -m "Initial commit for Fluent Do Agent"

# Install and create all necessary directories
RUN mkdir -p /fluent-bit/bin /fluent-bit/etc /fluent-bit/log
COPY source/conf/ /fluent-bit/etc/

ARG CMAKE_EXTRA_ARGS
ENV CMAKE_EXTRA_ARGS=${CMAKE_EXTRA_ARGS}

FROM source-builder AS builder

WORKDIR /source/build/

# Separate layers now for configure and build to allow local caching
#hadolint ignore=SC2086
RUN cmake -DCMAKE_BUILD_TYPE=Release \
    -DFLB_RELEASE=On \
    -DFLB_TESTS_INTERNAL=Off \
    -DFLB_TESTS_RUNTIME=Off \
    -DFLB_NIGHTLY_BUILD="$FLB_NIGHTLY_BUILD" \
    -DFLUENTDO_AGENT_VERSION="$FLUENTDO_AGENT_VERSION" \
    -DFLB_LOG_NO_CONTROL_CHARS=On \
    -DFLB_CORO_STACK_SIZE=131072 \
    ${CMAKE_EXTRA_ARGS} \
    ..

# Build and install, also copy to OSS default to make migration simple
ARG MAKE_EXTRA_ARGS
ENV MAKE_EXTRA_ARGS=${MAKE_EXTRA_ARGS}

RUN [ -n "$MAKE_EXTRA_ARGS" ] && make ${MAKE_EXTRA_ARGS} || make -j "$(getconf _NPROCESSORS_ONLN)" && \
    strip bin/fluent-bit && \
    install bin/fluent-bit /fluent-bit/bin/ && \
    install bin/fluent-bit /fluent-bit/bin/fluent-bit

# The release image now
FROM registry.access.redhat.com/ubi9/ubi-minimal:9.5 AS production

# hadolint ignore=DL3041
RUN microdnf update -y && microdnf install -y openssl libyaml && microdnf clean all

EXPOSE 2020

ENTRYPOINT [ "/fluent-bit/bin/fluent-bit" ]
CMD [ "/fluent-bit/bin/fluent-bit", "-c", "/fluent-bit/etc/fluent-bit.conf" ]

# Ensure we add licensing and help information for certification requirements
COPY licenses/* /licenses/
COPY README.md /help.1

COPY --from=builder /fluent-bit /fluent-bit

# Copy libgit2 and libssh2 runtime libraries from builder
COPY --from=builder /usr/local/lib64/libgit2.so* /usr/local/lib64/
COPY --from=builder /usr/local/lib/libssh2.so* /usr/local/lib/
RUN echo "/usr/local/lib64" > /etc/ld.so.conf.d/local-libs.conf && \
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/local-libs.conf && \
    ldconfig

RUN mkdir -p /opt/fluentdo-agent/etc
COPY config/ /opt/fluentdo-agent/etc/
COPY config/ /fluent-bit/etc/

# Generate schema and include as part of the container image
RUN /fluent-bit/bin/fluent-bit -J > /fluent-bit/etc/schema.json && \
    /fluent-bit/bin/fluent-bit -J > /opt/fluentdo-agent/etc/schema.json

ARG FLUENT_BIT_VERSION
ARG FLUENTDO_AGENT_VERSION

ENV FLUENTBIT_VERSION=$FLUENT_BIT_VERSION
ENV FLUENTDO_AGENT_VERSION=$FLUENTDO_AGENT_VERSION

# We need to override any base image labels
LABEL vendor='FluentDo at https://fluent.do'
LABEL maintainer='FluentDo via info@fluent.do'
LABEL name='FluentDo Agent'
LABEL io.k8s.display-name='FluentDo Agent'
LABEL summary='FluentDo Agent is an Enterprise hardened version of Fluent Bit'
LABEL url='https://fluent.do'
LABEL io.openshift.tags='observability,logging,log-aggregation,fluentdo,fluent-bit'
LABEL version=${FLUENTDO_AGENT_VERSION}
LABEL io.k8s.description='FluentDo Agent is a stable, secure by default, OSS (Apache-licensed) downstream distribution of Fluent Bit with predictable releases and long-term supported versions for 24 months.'

# Run as non-root user - pick a random one
RUN useradd -u 9876 -m -s /bin/false fluentdo-agent

USER 9876

# Support running integration tests directly in the production image
FROM bats/bats:1.12.0 AS bats
FROM production AS test

# Switch to root to install findutils and BATS
USER root

# We need find and ps/pkill for BATS
# hadolint ignore=DL3041
RUN microdnf update -y && microdnf install -y findutils procps && microdnf clean all

COPY --from=bats /opt/bats /opt/bats
RUN /opt/bats/install.sh /usr/local

USER 9876

ENV FLUENT_BIT_BINARY=/fluent-bit/bin/fluent-bit
COPY testing/ /testing/
WORKDIR /testing/bats
ENTRYPOINT [ "/testing/bats/run-bats.sh" ]
CMD [ "--recursive", "/testing/bats/tests/functional" ]

# Debug image for development
FROM builder AS debug
# hadolint ignore=DL3041
RUN dnf install -y gdb go-toolset procps && dnf clean all

COPY --from=production /opt/fluentdo-agent /opt/fluentdo-agent
COPY --from=production /fluent-bit /fluent-bit

ENTRYPOINT [ "bash" ]
